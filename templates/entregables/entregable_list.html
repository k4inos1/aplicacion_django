{% extends 'base.html' %}

{% block title %}Entregables - {{ block.super }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-list-task"></i> Entregables</h2>
    <a href="{% url 'entregable_create' %}" class="btn btn-info">
        <i class="bi bi-plus-circle"></i> Nuevo Entregable
    </a>
</div>

<!-- Filtros y Búsqueda -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <input type="text" name="q" class="form-control" placeholder="Buscar entregables..." value="{{ busqueda }}">
            </div>
            <div class="col-md-3">
                <select name="estado" class="form-select">
                    <option value="">Todos los estados</option>
                    {% for estado in estados %}
                    <option value="{{ estado.pk }}" {% if estado_filter == estado.pk|stringformat:"s" %}selected{% endif %}>
                        {{ estado.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select name="prioridad" class="form-select">
                    <option value="">Todas las prioridades</option>
                    {% for value, label in prioridades %}
                    <option value="{{ value }}" {% if prioridad_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search"></i> Filtrar</button>
            </div>
        </form>
    </div>
</div>

<!-- Lista de Entregables -->
{% if entregables %}
<div class="table-responsive">
    <table class="table table-hover">
        <thead class="table-dark">
            <tr>
                <th>Título</th>
                <th>Proyecto</th>
                <th>Responsable</th>
                <th>Estado</th>
                <th>Prioridad</th>
                <th>% Completado</th>
                <th>Vencimiento</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for entregable in entregables %}
            <tr {% if entregable.esta_vencido %}class="table-danger"{% endif %}>
                <td>
                    <a href="{% url 'entregable_detail' entregable.pk %}" class="text-decoration-none">
                        <strong>{{ entregable.titulo }}</strong>
                    </a>
                </td>
                <td>{{ entregable.proyecto.nombre }}</td>
                <td>{{ entregable.responsable.nombre|default:"Sin asignar" }}</td>
                <td>
                    <span class="badge" style="background-color: {{ entregable.estado.color }}">
                        {{ entregable.estado.nombre }}
                    </span>
                </td>
                <td>
                    <span class="badge badge-prioridad-{{ entregable.prioridad }}">
                        {{ entregable.get_prioridad_display }}
                    </span>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar" role="progressbar" style="width: {{ entregable.porcentaje_completado }}%"
                             aria-valuenow="{{ entregable.porcentaje_completado }}" aria-valuemin="0" aria-valuemax="100">
                            {{ entregable.porcentaje_completado }}%
                        </div>
                    </div>
                </td>
                <td>
                    {{ entregable.fecha_vencimiento }}
                    {% if entregable.esta_vencido %}
                        <i class="bi bi-exclamation-triangle text-danger" title="Vencido"></i>
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'entregable_detail' entregable.pk %}" class="btn btn-sm btn-info" title="Ver">
                        <i class="bi bi-eye"></i>
                    </a>
                    <a href="{% url 'entregable_update' entregable.pk %}" class="btn btn-sm btn-warning" title="Editar">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <a href="{% url 'entregable_delete' entregable.pk %}" class="btn btn-sm btn-danger" title="Eliminar">
                        <i class="bi bi-trash"></i>
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> No se encontraron entregables. 
    <a href="{% url 'entregable_create' %}" class="alert-link">¡Crea el primero!</a>
</div>
{% endif %}

<div class="mt-3">
    <a href="{% url 'index' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Volver al Inicio
    </a>
</div>
{% endblock %}
